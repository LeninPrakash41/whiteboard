HTMLElement.prototype.removeClass=HTMLElement.prototype.removeClass||function(a){this.className=this.className.split(" "+a).join("")},HTMLElement.prototype.addClass=HTMLElement.prototype.addClass||function(a){this.className+=" "+a},HTMLElement.prototype.hasClass=HTMLElement.prototype.hasClass||function(a){var b=this.className.split(" ");for(var c=b.length-1;c>=0;c--)if(b[c]===a)return!0;return!1},HTMLElement.prototype.applyCSSTransformation=HTMLElement.prototype.applyCSSTransformation||function(a){this.style.webkitTransform!=undefined?this.style.webkitTransform=a:this.style.MozTransform!=undefined?this.style.MozTransform=a:this.style.OTransform!=undefined?this.style.OTransform=a:this.style.msTransform!=undefined&&(this.style.msTransform=a)},HTMLElement.prototype.isContainedInElementOfClass=HTMLElement.prototype.isContainedInElementOfClass||function(a){var b=this;while(!b.hasClass(a)&&this!==document.getElementsByTagName("html")[0]&&b.parentElement)b=b.parentElement;return b.hasClass(a)?!0:!1},window.whiteboard=function(){function j(a,b,c){if(a.addEventListener)return a.addEventListener(b,c,!1);a.attachEvent("on"+b,c)}function k(a,b,c){return a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent("on"+b,c)}function l(a,b,c,d){var e;document.createEvent?(e=document.createEvent("HTMLEvents"),e.initEvent(b,!0,!0),a.dispatchEvent(e)):(e=document.createEventObject(),e.eventType=b,a.fireEvent("on"+e.eventType,e))}function m(a){a.currentTarget===document&&(g=e,f=d,d=window.Event?a.pageX:event.clientX+(document.documentElement.scrollLeft?document.documentElement.scrollLeft:c.scrollLeft),e=window.Event?a.pageY:event.clientY+(document.documentElement.scrollTop?document.documentElement.scrollTop:c.scrollTop),h=d-f,i=e-g)}function n(a){var b=typeof a.which=="number"?a.which:a.keyCode;return b==93||b==224?91:b>=96&&b<=105?b-48:b}function o(a){return b&&!a.defaultPrevented&&!a.target.isContainedInElementOfClass("stroke")&&!a.target.isContainedInElementOfClass("toolbox")}function p(a){b.paintStroke(),a.shiftKey||(b=null)}function q(a){j(document,"click",a)}function r(a){k(document,"click",a)}function s(a){a.preventDefault&&a.preventDefault(),b=t(a)}function t(b){var c=b.currentTarget.attributes.getNamedItem("data-brush-name").value;return a[c]}var a={},b,c=document.getElementsByTagName("html")[0],d,e,f,g,h,i,u={addEvent:j,removeEvent:k,fireEvent:l,addBrush:function(b){var c=b.attributes.getNamedItem("data-brush-name").value;a[c]=new this.Brush(b,c)},getBrush:function(b){return a[b]},init:function(){var a=document.getElementsByClassName("brush"),b=document.getElementsByClassName("tool");for(var c=0;c<a.length;c++)this.addBrush(a[c]);for(var c=0;c<b.length;c++)j(b[c],"click",s);j(document,"mousemove",m),j(document,"mousedown",function(a){o(a)&&p(a)})}};return u.Brush=function(){function b(a){var b,c,d,e,g=a.getElementsByClassName("whiteboard-actionable");for(e=g.length-1;e>=0;e--)b=g[e],b.ondragstart=function(){return!1},c=b.attributes.getNamedItem("data-action").value,d=b.attributes.getNamedItem("data-trigger").value,u.addEvent(b,d,f);u.addEvent(a,"mousedown",u.strokeActions.focus.invoke)}function f(a){var b=g(a.target),c=a.currentTarget.attributes.getNamedItem("data-action").value,d=b.getElementsByClassName("stroke-content")[0];u.strokeActions[c].invoke(a,d,b)}function g(a){var b=a;while(!b.hasClass("stroke")&&b!==c)b=b.parentElement;if(b.hasClass("stroke"))return b;throw new Error({name:"StrokeMissingException",message:"This element does not live inside a stroke.",element:a})}var a=function(a,b){this.template=a,this.name=b;var c=a.attributes.getNamedItem("data-onpaint");c&&(this.onpaint=c.value.split(", "))};return a.prototype.paintStroke=function(){var a=document.createElement("div");a.innerHTML=this.template.innerHTML,a.style.position="absolute",a.className="stroke",a.style.top=e,a.style.left=d,c.appendChild(a),u.strokeActions.focus.invoke({currentTarget:a});if(this.onpaint){var f;for(var g=this.onpaint.length-1;g>=0;g--)f=this.onpaint[g],u.strokeActions[f]&&u.strokeActions[f].invoke(),u.strokeActions.onpaint[f]&&u.strokeActions.onpaint[f](a)}b(a)},a}(),u.strokeActions=function(a){function f(){return document.getElementsByClassName("whiteboard-focused")[0]}function g(){return f().getElementsByClassName("stroke-content")[0]}function m(b,c,d){if(b.childElementCount==0)return b[c]=d;a.addEvent(b,c,d);for(var e=b.children.length-1;e>=0;e--)m(b.children[e],c,d)}function o(a){return p(a-180)?180:p(a+180)?-180:p(a-90)?90:p(a+90)?-90:p(a)?0:a}function p(a){return Math.abs(a)<5&&Math.abs(a)>-5}var b={onpaint:{focusEditableText:function(a){l(a.getElementsByClassName("editable")[0],"mousedown")}},move:{invoke:function(b,d,e){e.id="whiteboard-beingMoved",a.addEvent(c,"mousemove",a.strokeActions.move.process),a.addEvent(c,"mouseup",a.strokeActions.move.commit)},process:function(a){var b=document.getElementById("whiteboard-beingMoved");b.style.top=e-b.clientHeight+10,b.style.left=d},complete:function(b){document.getElementById("whiteboard-beingMoved").id="",a.removeEvent(c,"mouseup",a.strokeActions.move.complete),a.removeEvent(c,"mousemove",a.strokeActions.move.process)}},focus:{invoke:function(b){var c=f();c&&c.removeClass("whiteboard-focused"),a.addEvent(document,"keyup",a.strokeActions.destroy.invoke),b.currentTarget.addClass("whiteboard-focused"),q(a.strokeActions.focus.complete)},complete:function(b){if(!b.target.isContainedInElementOfClass("whiteboard-focused")){var c=f();c.removeClass("whiteboard-focused"),r(a.strokeActions.focus.complete),a.removeEvent(document,"keyup",a.strokeActions.destroy.invoke)}}},destroy:{invoke:function(b){return n(b)===8&&!b.target.hasClass("editable")&&(b.preventDefault&&b.preventDefault(),b.stopPropagation&&b.stopPropagation(),c.removeChild(f()),r(a.strokeActions.focus.complete)),!1}},rotate:{invoke:function(b,d){var e=f();a.addEvent(c,"mousemove",a.strokeActions.rotate.process),a.addEvent(c,"mouseup",a.strokeActions.rotate.complete)},process:function(a){var b=g(),c=b.attributes.getNamedItem("data-rotation");c||(c=document.createAttribute("data-rotation"),c.nodeValue=0);var d=o(Number(c.value)-h)%360;c.nodeValue=d,b.attributes.setNamedItem(c),b.applyCSSTransformation("rotate("+d+"deg)")},complete:function(b){a.removeEvent(c,"mousemove",a.strokeActions.rotate.process),a.removeEvent(c,"mouseup",a.strokeActions.rotate.complete)}},resize:{invoke:function(b){if(!1)j(c,"mousemove",a.strokeActions.resize.process),j(c,"mouseup",a.strokeActions.resize.complete)},process:function(a){var b=g();console.log(i,b.clientHeight),console.log(h,b.clientWidth),b.style.height=b.clientHeight+i,b.style.width=b.clientWidth+h},complete:function(b){k(c,"mousemove",a.strokeActions.resize.process),k(c,"mouseup",a.strokeActions.resize.complete)}},increaseFontSize:{invoke:function(a,b){var c=Number(b.style.fontSize.split("px")[0]);c||(c=Number(b.attributes.getNamedItem("data-default-fontsize").value)),b.style.fontSize=c+2+"px"}},decreaseFontSize:{invoke:function(a,b){var c=Number(b.style.fontSize.split("px")[0]);b.style.fontSize=c-2+"px"}},editText:{invoke:function(b){var c=b.target;c.contentEditable="true",c.id="whiteboard-beingEdited",j(c,"keydown",a.strokeActions.editText.complete),q(a.strokeActions.editText.complete)},complete:function(b){if(!b.target.isContainedInElementOfClass("editable")){var c=document.getElementById("whiteboard-beingEdited");c.contentEditable="false",c.id="",k(c,"keydown",a.strokeActions.editText.complete),r(a.strokeActions.editText.complete)}}},addHandler:function(b,c){a.strokeActions[b]=c}};return b}(u),u}();
