HTMLElement.prototype.removeClass=HTMLElement.prototype.removeClass||function(a){this.className=this.className.split(" "+a).join("")},HTMLElement.prototype.addClass=HTMLElement.prototype.addClass||function(a){this.className+=" "+a},HTMLElement.prototype.hasClass=HTMLElement.prototype.hasClass||function(a){var b=this.className.split(" ");for(var c=b.length-1;c>=0;c--)if(b[c]===a)return!0;return!1},HTMLElement.prototype.applyCSSTransformation=HTMLElement.prototype.applyCSSTransformation||function(a){this.style.webkitTransform!=undefined?this.style.webkitTransform=a:this.style.MozTransform!=undefined?this.style.MozTransform=a:this.style.OTransform!=undefined?this.style.OTransform=a:this.style.msTransform!=undefined&&(this.style.msTransform=a)},HTMLElement.prototype.isContainedInElementOfClass=HTMLElement.prototype.isContainedInElementOfClass||function(a){var b=this;while(!b.hasClass(a)&&this!==document.getElementsByTagName("html")[0]&&b.parentElement)b=b.parentElement;return b.hasClass(a)?!0:!1},window.whiteboard=function(){function e(b){var c=[],d,e;for(var f in a)e=f.replace(".","\\.").replace("*",".+"),d=b.match(e),d&&d.shift()===b&&(c=c.concat(a[f]));return c}function f(a){return a.currentTarget===document&&(d=b.mouseY,c=b.mouseX,b.mouseX=window.Event?a.pageX:event.clientX+(document.documentElement.scrollLeft?document.documentElement.scrollLeft:b.container.scrollLeft),b.mouseY=window.Event?a.pageY:event.clientY+(document.documentElement.scrollTop?document.documentElement.scrollTop:b.htmlTag.scrollTop),b.deltaX=b.mouseX-c,b.deltaY=b.mouseY-d),whiteboard}var a={},b,c,d;return b={htmlTag:document.getElementsByTagName("html")[0],addEvent:function(a,b,c){return a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c),whiteboard},removeEvent:function(a,b,c){return a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent("on"+b,c),whiteboard},fireEvent:function(a,b,c,d){var e;return document.createEvent?(e=document.createEvent("HTMLEvents"),e.initEvent(b,!0,!0),a.dispatchEvent(e)):(e=document.createEventObject(),e.eventType=b,a.fireEvent("on"+e.eventType,e)),whiteboard},on:function(b,c){return a[b]=a[b]||[],a[b].push(c),this},off:function(b,c){var d=a[b];if(!d)return;if(arguments.length==1){delete a[b];return}var e=d.indexOf(c);return d.splice(e,1),this},emit:function(a){var b=[].slice.call(arguments,1),c=e(a);if(c)for(var d=0,f=c.length;d<f;++d)c[d].apply(this,b);return this},initSubmodules:function(a){a=a||this;for(var b in a)a.hasOwnProperty(b)&&b.charAt(0)>="A"&&b.charAt(0)<="Z"&&typeof this[b].init=="function"&&a[b].init()},init:function(){return b.initSubmodules(),b.addEvent(document,"mousemove",f),this}}}(),whiteboard.Brush=function(a){function d(a){var c=a.currentTarget.attributes.getNamedItem("data-brush-name").value;return b[c]}function e(a){return a.preventDefault&&a.preventDefault(),c.active=d(a),c}function f(a){return c.active&&!a.defaultPrevented&&!a.target.isContainedInElementOfClass("stroke")&&!a.target.isContainedInElementOfClass("toolbox")}function g(a){return c.active.paintStroke(),a.shiftKey||(c.active=null),c}var b={},c=function(a,b){this.template=a,this.name=b;var c=a.attributes.getNamedItem("data-onpaint");c&&(this.onpaint=c.value.split(", "))};return c.active=null,c.init=function(){var b=document.getElementsByClassName("brush"),d=document.getElementsByClassName("tool");for(var h=0;h<b.length;h++)c.add(b[h]);for(var h=0;h<d.length;h++)a.addEvent(d[h],"click",e);a.addEvent(document,"mousedown",function(a){f(a)&&g(a)})},c.add=function(a){var d=a.attributes.getNamedItem("data-brush-name").value;return b[d]=new c(a,d),this},c.get=function(a){return b[a]},c.prototype.paintStroke=function(b){return b?a.htmlTag.appendChild(b):b=a.Stroke.create(this),b},c}(whiteboard),whiteboard.Canvas=function(a){function c(a,b){return{action:b,target:{canvas:this,stroke:a}}}var b=function(a){var b=(new Date).toJSON();a=a||{},this.strokes=a.strokes||{},this.id=a.id||b,this.name=a.name||b+"-Untitled",this.createdAt=a.createdAt||b};return b.prototype={createOrUpdateStroke:function(b){var d=this.strokes.hasOwnProperty(b.id);this.strokes[b.id]=b,d?a.emit("Canvas.strokes.update",c.call(this,b,"update")):a.emit("Canvas.strokes.create",c.call(this,b,"create"))},handleStrokeChange:function(b){if(b.action==="focus"||b.action==="unfocus")return;b.action==="destroy"?(delete this.strokes[b.target.id],a.emit("Canvas.strokes.destroy",c.call(this,b.target,"destroy"))):this.createOrUpdateStroke(b.target)}},b.active=null,b.init=function(){this.active=this.active||new b,a.on("^(StrokeAction|Stroke).(?!(un)?focus)*commit",function(a){b.active.handleStrokeChange(a)})},b}(whiteboard),whiteboard.Stroke=function(a){function c(){var b,c,d,e,f=this.getElementsByClassName("whiteboard-actionable");for(e=f.length-1;e>=0;e--)b=f[e],b.ondragstart=function(){return!1},c=b.attributes.getNamedItem("data-action").value,d=b.attributes.getNamedItem("data-trigger").value,a.addEvent(b,d,a.StrokeAction.invokeStrokeActionFromEvent);a.addEvent(this,"mousedown",a.StrokeAction.focus.invoke)}var b={includedBy:function(a){a.whiteboard={};for(var c in b.prototype)a[c]=function(a,c){return function(){return b.prototype[c].apply(a,arguments)}}(a,c)},create:function(b){var d=document.createElement("div");return d.innerHTML=b.template.innerHTML,d.style.position="absolute",d.className="stroke",d.style.top=a.mouseY+"px",d.style.left=a.mouseX+"px",d.id=b.name+"#"+(new Date).toJSON(),d.brush=b,a.htmlTag.appendChild(d),a.Stroke.includedBy(d),c.call(d),a.emit("Stroke.create.commit",{target:d,module:"Stroke",action:"create",step:"commit"}),a.StrokeAction.focus.invoke({currentTarget:d,target:d}),d}};return b.prototype={updateWhiteboardAttributes:function(a,b,c){b=b||this,c=c||this.whiteboard;for(var d in a)typeof a[d]=="object"?(c[d]=c[d]||{},this.updateWhiteboardAttributes(a[d],b[d],c[d])):c[d]=b[d]=a[d]},whiteboardHTML:function(){return this.outerHTML||function(a){var b=document.createElement("div"),c;return b.appendChild(a.cloneNode(!0)),c=b.innerHTML,b=null,c}(this)},serialize:function(){return{id:this.id,brush:this.brush.name,html:this.whiteboardHTML()}}},b}(whiteboard),whiteboard.StrokeAction=function(a){var b="StrokeAction";return{on:function(c,d){return a.on(b+"."+c,d)},off:function(c,d){return a.off(b+"."+c,d)},emit:function(c,d){return c=b+"."+c,d.module=b,a.emit(c,d)},extend:function(c,d){var e={on:function(d,e){return a.on(b+"."+c+"."+d,e)},off:function(d,e){return a.off(b+"."+c+"."+d,e)},emit:function(b,d){return b=c+"."+b,d.action=c,a.StrokeAction.emit(b,d)}};for(var f in d)e[f]=function(a,b){return function(c){b.apply(e,arguments),e.emit(a,{step:a,e:c,target:e.target})}}(f,d[f]);return d.init&&d.init.call(e),e},enableDocumentClickCatching:function(b){a.addEvent(document,"click",b)},disableDocumentClickCatching:function(b){a.removeEvent(document,"click",b)},focusedStroke:function(){return document.getElementsByClassName("whiteboard-focused")[0]},focusedStrokeContent:function(){return this.focusedStroke().getElementsByClassName("stroke-content")[0]},addEventToNodeAndChildren:function(b,c,d){if(b.childElementCount==0)return b[c]=d;a.addEvent(b,c,d);for(var e=b.children.length-1;e>=0;e--)_addEventToNodeAndChildren(b.children[e],c,d)},keyCodeFromEvent:function(a){var b=typeof a.which=="number"?a.which:a.keyCode;return b==93||b==224?91:b>=96&&b<=105?b-48:b},invokeStrokeActionFromEvent:function(b){var c=b.currentTarget.attributes.getNamedItem("data-action").value;a.StrokeAction[c].invoke(b)},strokeForElement:function(b){if(!b)return a.StrokeAction.focusedStroke();var c=b;while(!c.hasClass("stroke")&&c!==a.htmlTag)c=c.parentElement;return c.hasClass("stroke")?c:whiteboard.StrokeAction.focusedStroke()}}}(whiteboard),whiteboard.StrokeAction.decreaseFontSize=whiteboard.StrokeAction.extend("decreaseFontSize",{invoke:function(a){this.target=whiteboard.StrokeAction.strokeForElement(a.target),this.commit()},commit:function(){var a=this.target.getElementsByClassName("stroke-content")[0];pixels=Number(a.style.fontSize.split("px")[0]),a.style.fontSize=pixels-2+"px"}}),whiteboard.StrokeAction.destroy=function(a,b){return b.extend("destroy",{invoke:function(a){return a.preventDefault&&a.preventDefault(),this.target=b.strokeForElement(a.target),this.commit(),!1},commit:function(b){a.htmlTag.removeChild(this.target)}})}(whiteboard,whiteboard.StrokeAction),whiteboard.StrokeAction.editText=function(a,b){return b.extend("editText",{invoke:function(a){this.target=a.target,this.target.contentEditable="true",b.enableDocumentClickCatching(b.editText.process)},process:function(a){a.target.isContainedInElementOfClass("editable")||b.editText.commit()},commit:function(){this.target.contentEditable="false",b.disableDocumentClickCatching(b.editText.process)}})}(whiteboard,whiteboard.StrokeAction),whiteboard.StrokeAction.focus=function(a,b){function c(a){this.target&&this.target.removeClass("whiteboard-focused"),this.target=a,a&&a.addClass("whiteboard-focused")}return b.extend("focus",{invoke:function(a){c.call(this,a.currentTarget),this.commit()},commit:function(){}})}(whiteboard,whiteboard.StrokeAction),whiteboard.StrokeAction.increaseFontSize=whiteboard.StrokeAction.extend("increaseFontSize",{invoke:function(a,b){this.target=whiteboard.StrokeAction.strokeForElement(a.target),this.commit()},commit:function(){var a=this.target.getElementsByClassName("stroke-content")[0],b=Number(a.style.fontSize.split("px")[0]);b||(b=Number(a.attributes.getNamedItem("data-default-fontsize").value)),a.style.fontSize=b+2+"px"}}),whiteboard.StrokeAction.move=function(a,b){return b.extend("move",{invoke:function(c,d,e){this.target=b.strokeForElement(c.target),a.addEvent(a.htmlTag,"mousemove",this.process),a.addEvent(a.htmlTag,"mouseup",this.commit)},process:function(b){this.target.style.top=a.mouseY-this.target.clientHeight+10+"px",this.target.style.left=a.mouseX+"px"},commit:function(b){a.removeEvent(a.htmlTag,"mouseup",this.commit),a.removeEvent(a.htmlTag,"mousemove",this.process)}})}(whiteboard,whiteboard.StrokeAction),whiteboard.StrokeAction.rotate=function(a,b){function c(a){return d(a-180)?180:d(a+180)?-180:d(a-90)?90:d(a+90)?-90:d(a)?0:a}function d(a){return Math.abs(a)<5&&Math.abs(a)>-5}return b.extend("rotate",{invoke:function(c,d){this.target=b.strokeForElement(c.target),a.addEvent(a.htmlTag,"mousemove",this.process),a.addEvent(a.htmlTag,"mouseup",this.commit)},process:function(b){var d=this.target.getElementsByClassName("stroke-content")[0],e=d.attributes.getNamedItem("data-rotation");e||(e=document.createAttribute("data-rotation"),e.nodeValue=0);var f=c(Number(e.value)-a.deltaX)%360;e.nodeValue=f,d.attributes.setNamedItem(e),d.applyCSSTransformation("rotate("+f+"deg)")},commit:function(b){a.removeEvent(a.htmlTag,"mousemove",this.process),a.removeEvent(a.htmlTag,"mouseup",this.commit)}})}(whiteboard,whiteboard.StrokeAction),whiteboard.StrokeAction.unfocus=function(a,b){return b.extend("unfocus",{init:function(){b.on("focus.commit",this.invoke)},invoke:function(){b.enableDocumentClickCatching(this.process)},process:function(a){a.target.isContainedInElementOfClass("whiteboard-focused")||this.commit()},commit:function(){this.target=b.focus.target,this.target.removeClass("whiteboard-focused"),b.disableDocumentClickCatching(this.process)}})}(whiteboard,whiteboard.StrokeAction);
